// ----------------------------------------------------------------------------
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
// ----------------------------------------------------------------------------

// API Endpoint to get the JSON response of Embed URL, Embed Token and reportId

const quickVisualCreatorReportEndpoint = {
    //dataset Id
    "Id": "77c41624-78ea-4f88-8f3a-6295a7518e11",
    "EmbedUrl": "https://app.high.powerbigov.us/reportEmbed?reportId=fa6f9501-7169-4fe1-8c98-386dabff2ab2&groupId=8703a75d-64f6-478f-872b-8365a793e368&w=2&config=eyJjbHVzdGVyVXJsIjoiaHR0cHM6Ly9XQUJJLVVTLUdPVi1UQi1URVhBUy1yZWRpcmVjdC5oaWdoLmFuYWx5c2lzLnVzZ292Y2xvdWRhcGkubmV0IiwiZW1iZWRGZWF0dXJlcyI6eyJ1c2FnZU1ldHJpY3NWTmV4dCI6dHJ1ZSwiZGlzYWJsZUFuZ3VsYXJKU0Jvb3RzdHJhcFJlcG9ydEVtYmVkIjp0cnVlfX0%3d",
    "Type": "visual",
    "EmbedToken": {
        "token": "H4sIAAAAAAAEAB2Tt66EVgAF_-W1a4mcLLkgLUsOC1ygI-ecsfzvfnY_zRmd-fvHiu9ujLOfP3-GCXZJSTSNNUYklpvhFjUZDE9wWZ_7rCtZ3KG0XEVSd1osQWhY9hm7CnUUmEerdtnxIVef_IXTJq0QET7FRGtdto6HEcWmZHlkM7agSXKPRhSnsP3RQ-qM6COEFVGgVvd6wdutnAmkAcMWxiaKyL5acIXKNObVUkXN1lr1VEWF2x6nIlDAFqjoTvz0JKuQMSZFvjziqv2i2TNJ4-SQivnmuYHko5SQrMn5DfFomMHNNWcyLA1ITCRpEDSzotvy8abUYW9apzdZDq4uCwo_EQdJW91ZbHWJvuKt-z6TBbyl5-YZ8z810OYej4uEX-KyoeeRt7GKt7UwATtESKxiCQNlzO9OmpReuk_QjqTPfq_IXPpJcbd2k_3CM0UGZXIic9UPI0LFaOebP4yTGqVbCACiwwdsXVc49oBzHiThRJF4ZfQcOP1SHuMXdctm-2YDJD9WM0GuXVaqx7EJRjnCrb21wFBeAiX318sVee8EhaXuXF-MWtZmnxobhKD3M8hzVE86kKGNJhfsLNw57mid0fmO0dDD6aLH6UDgNiWi3346msV9VUBwp2x6GPt51JPq3c86TqknAsu18L3JZ5VeBQS3oqF8heaK2mpo5XCQiJDM5t8ZdhRPT-LzCWLXBPaOTRpRBEGhtHxGubzd6mS8NqSWUwgP4XNkPk_lMo2lyRW2rmwteOotHf6kZNstZokVVXdhZt159bcqQ4gjfOMwu-yKJpdonYz6RoiW6T2dnEQV38UGHrG0Uhz6e7OUm9z2B9K6RrbD_dIGF-tizeebjdF9kqqqw9MkL3TFEX5QiObaVRknE7a8XHrb6UIrOcaoO-O7688fP_xyT9uo5vdvTimPcrDNk7cHRhhB1eHwqsKwVxO20dqAWpt6CC3w8sL7IG6cW3QlgaRflbCmVdkkSd-L6kZYToEvmb5baAfWkstU78oE4dILxyfQFN4lHwP3nt5OkFlahgiiRAV4XYG-rUQ6wyaxF3DiWb6SX1w23gQlFR_4t_iNXTzZJT4mBqUNBTl8OBMpFxuaIvbCu80uPixehYnVb13V0zIvNHJPD2Cli8QOfJ1TbkBdrku6icoD5M6svaYEX13QI2LIhKkJlQuIo1yqT2xf3zZAh5sGiZ8sJ3gAhYqRGvWDX-791FtojhQwF7ftJ3sAfk_H50Psq9LaicO63WbIg2pMH-PQf-_O_vXXf5rvqcoX2f_PslHeLg8J-ZaDOEhMacgN0v6f-tblEG_7kv9inWQep9PEYB91OmmzUeOU0ErfIonrcNfLD-5kuCpqPL4ICVGpawotRwN73nhK8HOKT6n2mf3Rmi9UwY4kfoNcacmacVA2HeaJEYxzSVVsv6CzjiB0A-IeSC4t-bM3P1MlOYBXURKdapmKWZo97bS9JPre8NlGYLwmGu1F5dhq5p7FuA1XrSY2d3wCsy2_V3l4PoV1KoxKw6GlDyWfXo12x2TO6DdB9wB73tbIaMEybmWfmItVd0uwd7MRSTjDUaiLymsEseopvbHScwBR4-hC8RXmV_DNqddUmS0TLiAY7i789WCst1lW9fU7QXw_YnWMg60SrvEaq1mnSMkyjgDg5vmr-Z9_AVsgVfRCBgAA.eyJjbHVzdGVyVXJsIjoiaHR0cHM6Ly9XQUJJLVVTLUdPVi1UQi1URVhBUy1yZWRpcmVjdC5oaWdoLmFuYWx5c2lzLnVzZ292Y2xvdWRhcGkubmV0IiwiZXhwIjoxNzA2MDI0MDU2LCJhbGxvd0FjY2Vzc092ZXJQdWJsaWNJbnRlcm5ldCI6dHJ1ZX0=",
        "tokenId": "2b0f5dd3-f119-4f53-969a-0ce1145daef7",
        "expiration": "2024-01-23T15:34:16Z"
    },
    "MinutesToExpiration": 59,
    "DefaultPage": null,
    "MobileDefaultPage": null
};

// Set minutes before the access token should get refreshed
const minutesToRefreshBeforeExpiration = 2;

// Store the amount of time left for refresh token
let tokenExpiration;

// This function will make the AJAX request to the endpoint and get the JSON response which it will set in the sessions
function populateEmbedConfigIntoCurrentSession(updateCurrentToken) {

    try {
        debugger
        let configFromParentWindow = quickVisualCreatorReportEndpoint;
        if (configFromParentWindow) {
            let diffMs = new Date(configFromParentWindow.EmbedToken.expiration) - new Date();
            let diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000);

            embedConfig = {
                EmbedUrl: configFromParentWindow.EmbedUrl,
                EmbedToken: {
                    Token: configFromParentWindow.EmbedToken.token
                },
                Id: configFromParentWindow.Id,
                MinutesToExpiration: diffMins,
            };

            handleNewEmbedConfig(embedConfig, updateCurrentToken);
        }

        return;
    } catch (error) {
        console.error(error);
    }

    // This returns the JSON response
    //return $.getJSON(quickVisualCreatorReportEndpoint, function (embedConfig) {
    //    handleNewEmbedConfig(embedConfig, updateCurrentToken);
    //});

    handleNewEmbedConfig(quickVisualCreatorReportEndpoint, updateCurrentToken);
}

function handleNewEmbedConfig(embedConfig, updateCurrentToken) {

    // Set Embed Token, Embed URL and Report Id
    setConfig(embedConfig.EmbedToken.Token, embedConfig.EmbedUrl, embedConfig.Id);
    if (updateCurrentToken) {

        // Get the reference to the embedded element
        const reportContainer = $(".report-container").get(0);
        if (reportContainer) {
            const report = powerbi.get(reportContainer);
            report.setAccessToken(embedConfig.EmbedToken.Token);
        }

        // Get the reference to the embedded element
        const visualDisplayArea = $("#visual-authoring-container").get(0);
        if (visualDisplayArea) {
            const visualAuthoringReport = powerbi.get(visualDisplayArea);
            visualAuthoringReport.setAccessToken(embedConfig.EmbedToken.Token);
        }
    }

    // Get the milliseconds after token will get refreshed
    tokenExpiration = embedConfig.MinutesToExpiration * 60 * 1000;

    // Set the tokenRefresh timer to count the seconds and request the JSON again when token expires
    setTokenExpirationListener();
}

// Check the remaining time and call the API again
function setTokenExpirationListener() {

    const safetyInterval = minutesToRefreshBeforeExpiration * 60 * 1000;

    // Time until token refresh in milliseconds
    const timeout = tokenExpiration - safetyInterval;
    if (timeout <= 0) {
        populateEmbedConfigIntoCurrentSession(true /* updateCurrentToken */);
    }
    else {
        console.log(`Report Embed Token will be updated in ${timeout} milliseconds.`);
        setTimeout(function () {
            populateEmbedConfigIntoCurrentSession(true /* updateCurrentToken */)
        }, timeout);
    }
}

// Add a listener to make sure token is updated after tab was inactive
document.addEventListener("visibilitychange", function () {
    // Check the access token when the tab is visible
    if (!document.hidden) {
        setTokenExpirationListener();
    }
});

// Get the data from the API and pass it to the front-end
function loadQuickVisualCreatorReportConfigIntoSession() {

    // Call the function for the first time to call the API, set the sessions values and return the response to the front-end
    return populateEmbedConfigIntoCurrentSession(false /* updateCurrentToken */);
}

//const tokenToday = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6ImZ3TnM4Rl9oOUtySE1BX09jVFAxcEdGV3d5YyIsImtpZCI6ImZ3TnM4Rl9oOUtySE1BX09jVFAxcEdGV3d5YyJ9.eyJhdWQiOiJodHRwczovL2hpZ2guYW5hbHlzaXMudXNnb3ZjbG91ZGFwaS5uZXQvcG93ZXJiaS9hcGkiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mMzJiMWQ5Zi0wM2Y5LTQyZmItOGM2NC1jNjk2M2UzYTY3ZjkvIiwiaWF0IjoxNzA1NDk4NDY3LCJuYmYiOjE3MDU0OTg0NjcsImV4cCI6MTcwNTUwMjM2NywiYWlvIjoiNDJaZ1lEanhnK25wMUJVM3VneTVmMzI1SUI1bER3QT0iLCJhcHBpZCI6IjExZjBhMmU5LTJjNmItNGQ1ZC1iNDEwLTIxMDI3MTFmNzg1NiIsImFwcGlkYWNyIjoiMSIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0L2YzMmIxZDlmLTAzZjktNDJmYi04YzY0LWM2OTYzZTNhNjdmOS8iLCJpZHR5cCI6ImFwcCIsIm9pZCI6IjIwYmY2YzYwLWQ1OTgtNDdiZi04ZWYwLWNkOTFlOWVmNTkxOSIsInJoIjoiMC5Dd01Bbngwcjhfa0QtMEtNWk1hV1BqcG4tZVY1U2Z5bENwOUNzVHBkRTJXLVZXWURBQUEuIiwic3ViIjoiMjBiZjZjNjAtZDU5OC00N2JmLThlZjAtY2Q5MWU5ZWY1OTE5IiwidGlkIjoiZjMyYjFkOWYtMDNmOS00MmZiLThjNjQtYzY5NjNlM2E2N2Y5IiwidXRpIjoiWDVUeXQzbFRwRVMzaDNWRUJ2b1lBQSIsInZlciI6IjEuMCJ9.NG7BktYr0R5U1myVWXRj8G3rlmcDrYH6IObIpbW6FpK0bCHgINw1carK6jq1N7y8RSRSuuy4f2UNHLg8H2px9FpyLw6oNsvAB6TkEStTF8rUTL-ab2V0ICFvwU1n3Xk7aRbZxMy-BaHvKBey2E6BvX3Fsm0r2V8g_jbhgoEnIZ3avhx5rSeR5TL2SqKNl1ruS4kdY7yJhzRE82iVs20cqqGNdKptSZQZChG1N8GX6G0P1mYpWcs34qLWT31BB7dKUUr8K5LMjQYqatyKsqhtOSmKDwi4a1dldQ8imS2cHzRrzmlSC_JszVvyTdL7c9CqQrDGF8nv8QxwH7W_exQRoA";


// Set the embed config in global object
function setConfig(accessToken, embedUrl, reportId) {

    // Fill the global object
    debugger
    reportConfig.accessToken = quickVisualCreatorReportEndpoint.EmbedToken.token;
    reportConfig.embedUrl = quickVisualCreatorReportEndpoint.EmbedUrl;
    reportConfig.reportId = quickVisualCreatorReportEndpoint.Id;


}

